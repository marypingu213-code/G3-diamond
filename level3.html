<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¬¬ä¸‰é—œï¼šæ–‡æ„å°åµæ¢</title>
    <script src="data.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
            overscroll-behavior-y: none; 
        }
        .word-card {
            cursor: grab; transition: all 0.2s; user-select: none; touch-action: none; 
        }
        .word-card:active { cursor: grabbing; transform: scale(1.05); }
        .drop-zone {
            display: inline-flex; min-width: 120px; height: 40px; border-bottom: 3px dashed #3b82f6; margin: 0 8px; vertical-align: middle; justify-content: center; align-items: center; transition: background-color 0.3s; cursor: pointer;
        }
        .drop-zone.hover { background-color: #dbeafe; border-radius: 8px; border-bottom-style: solid; }
        .correct { color: #059669; border-bottom-color: #059669; border-bottom-style: solid; font-weight: bold; }
        .wrong { color: #dc2626; border-bottom-color: #dc2626; border-bottom-style: solid; font-weight: bold; animation: shake 0.4s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden border-4 border-yellow-400 relative">
        
        <div class="bg-yellow-400 p-6 text-center relative">
            <div class="absolute top-4 left-4 flex flex-col md:flex-row gap-2 z-50">
                <a href="index.html" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow hover:bg-blue-700 text-sm md:text-base border-2 border-blue-800 transition transform active:scale-95">ğŸ  å›ç¸½å¤§å»³</a>
                <a href="#" id="back-btn" class="bg-white text-blue-800 font-bold py-2 px-4 rounded-full shadow hover:bg-gray-100 text-sm md:text-base border-2 border-gray-200 transition transform active:scale-95">ğŸ”™ å›é¸å–®</a>
            </div>

            <h1 class="text-3xl md:text-4xl font-bold text-white drop-shadow-md mt-16 md:mt-0">ğŸ“ <span id="lesson-title">èªè©å¡«ç©ºæ¸¬é©—</span></h1>
            <p class="text-yellow-900 mt-2 font-medium text-lg">è«‹ç”¨æ‰‹æŒ‡å°‡æ­£ç¢ºçš„èªè©æ‹–å‹•åˆ°æ ¼å­è£¡ï¼</p>
        </div>

        <div class="p-6 bg-yellow-50 border-b-2 border-yellow-100">
            <div class="text-sm font-bold text-yellow-700 mb-3 flex items-center">
                <span class="bg-yellow-200 px-3 py-1 rounded-full text-xs mr-2">èªè©éŠ€è¡Œ</span>
                é•·æŒ‰èªè©ï¼Œæ‹–æ›³åˆ°ä¸‹æ–¹çš„åº•ç·šä¸­å–”ï¼
            </div>
            <div id="word-bank" class="flex flex-wrap gap-3 justify-center min-h-[60px]"></div>
        </div>

        <div class="p-6 md:p-10">
            <div id="quiz-list" class="space-y-8 min-h-[100px]"></div>

            <div class="mt-12 flex flex-col md:flex-row gap-4 justify-center items-center" id="action-btns">
                <button onclick="checkAnswers()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-10 rounded-full shadow-lg transform transition active:scale-95 text-xl">
                    âœ… å®ŒæˆæŒ‘æˆ°ï¼
                </button>
                <button onclick="resetQuiz()" class="text-blue-500 hover:text-blue-700 font-bold py-2 px-6 rounded-full border-2 border-blue-500 transition active:bg-blue-50">
                    ğŸ”„ é‡æ–°é–‹å§‹
                </button>
            </div>

            <div id="result-message" class="hidden mt-8 p-6 rounded-2xl text-center transform transition-all duration-500">
                <h2 id="score-text" class="text-2xl font-bold mb-2"></h2>
                <p id="feedback-text" class="text-lg"></p>
                <a href="#" id="finish-btn" class="hidden inline-block mt-4 bg-green-500 text-white font-bold py-2 px-8 rounded-full shadow hover:bg-green-600 transition transform active:scale-95">å›èª²ç¨‹é¸å–®</a>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const lessonId = urlParams.get('id') || "1"; 
        
        // ğŸŒŸ é˜²å‘†è¨­è¨ˆï¼šå°±ç®— HTML é›¶ä»¶è¢«åˆªæ‰ä¹Ÿä¸æœƒç•¶æ©Ÿ
        const backBtn = document.getElementById('back-btn');
        const finishBtn = document.getElementById('finish-btn');
        if(backBtn) backBtn.href = `lesson.html?id=${lessonId}`;
        if(finishBtn) finishBtn.href = `lesson.html?id=${lessonId}`;

        let questions = [];
        let lessonData = null;
        
        // æª¢æŸ¥å¤§è…¦è³‡æ–™åº«æ˜¯å¦å­˜åœ¨
        if (typeof allLessonsData !== 'undefined') {
            lessonData = allLessonsData[lessonId];
            if (lessonData && lessonData.level3) {
                questions = lessonData.level3;
            }
        }

        let words = [];
        let draggedWord = "";
        let ghostEl = null;

        function shuffle(array) {
            return [...array].sort(() => Math.random() - 0.5);
        }

        function initQuiz() {
            const quizList = document.getElementById('quiz-list');
            const wordBank = document.getElementById('word-bank');
            const actionBtns = document.getElementById('action-btns');
            const titleEl = document.getElementById('lesson-title');

            if (!questions || questions.length === 0) {
                quizList.innerHTML = "<p class='text-center text-gray-500 text-xl font-bold w-full'>æœ¬èª²ç›®å‰æ²’æœ‰ç¬¬ä¸‰é—œçš„é¡Œç›®å–”ï¼<br>ï¼ˆè«‹ç¢ºèªå¤§å»³æ˜¯å¦é»é¸äº†æ­£ç¢ºçš„èª²æ¬¡ï¼‰</p>";
                actionBtns.style.display = 'none';
                return;
            }

            actionBtns.style.display = 'flex'; 

            // è‡ªå‹•æ›¿æ›æ¨™é¡Œ
            if (lessonData && titleEl) {
                titleEl.innerText = lessonData.title + " (å¡«ç©ºæ¸¬é©—)";
            }

            words = questions.map(q => q.answer);
            wordBank.innerHTML = '';
            shuffle(words).forEach(word => {
                const card = document.createElement('div');
                card.className = 'word-card bg-white border-2 border-yellow-400 px-4 py-2 rounded-xl shadow-sm font-bold text-xl text-blue-800';
                card.innerText = word;
                card.addEventListener('pointerdown', handlePointerDown);
                wordBank.appendChild(card);
            });

            quizList.innerHTML = '';
            questions.forEach((q, index) => {
                let parts = q.text.split(/_+/);
                let prefix = parts[0] || "";
                let suffix = parts[1] || "";

                const item = document.createElement('div');
                item.className = 'text-xl md:text-2xl leading-relaxed flex flex-wrap items-center text-gray-700';
                item.innerHTML = `
                    <span class="font-bold text-blue-400 mr-2 bg-blue-50 px-3 py-1 rounded-lg">${index + 1}</span>
                    <span>${prefix}</span>
                    <div class="drop-zone mx-2 text-blue-600" data-id="${index}"></div>
                    <span>${suffix}</span>
                `;
                quizList.appendChild(item);
            });

            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('click', () => {
                    zone.innerText = '';
                    zone.classList.remove('correct', 'wrong');
                });
            });
        }

        // è§¸æ§æ‹–æ›³é‚è¼¯
        function handlePointerDown(e) {
            e.preventDefault();
            draggedWord = this.innerText;
            
            ghostEl = this.cloneNode(true);
            ghostEl.style.position = 'fixed';
            ghostEl.style.zIndex = '9999';
            ghostEl.style.opacity = '0.9';
            ghostEl.style.pointerEvents = 'none'; 
            ghostEl.style.boxShadow = '0 15px 25px rgba(0,0,0,0.2)';
            ghostEl.style.transform = 'scale(1.1)';
            
            document.body.appendChild(ghostEl);
            moveGhost(e.clientX, e.clientY);

            document.addEventListener('pointermove', handlePointerMove);
            document.addEventListener('pointerup', handlePointerUp);
        }

        function moveGhost(x, y) {
            if(ghostEl) {
                ghostEl.style.left = (x - ghostEl.offsetWidth / 2) + 'px';
                ghostEl.style.top = (y - ghostEl.offsetHeight / 2) + 'px';
            }
        }

        function handlePointerMove(e) {
            e.preventDefault();
            moveGhost(e.clientX, e.clientY);
        }

        function handlePointerUp(e) {
            document.removeEventListener('pointermove', handlePointerMove);
            document.removeEventListener('pointerup', handlePointerUp);
            
            if (ghostEl) {
                ghostEl.style.display = 'none';
                let dropZone = null;
                
                const elements = document.elementsFromPoint(e.clientX, e.clientY);
                for (let el of elements) {
                    if (el.classList.contains('drop-zone')) {
                        dropZone = el;
                        break;
                    }
                }
                
                if (dropZone && draggedWord) {
                    dropZone.innerText = draggedWord;
                    dropZone.classList.remove('correct', 'wrong');
                }
                
                ghostEl.remove();
                ghostEl = null;
            }
            draggedWord = "";
        }

        function checkAnswers() {
            if (!questions || questions.length === 0) return;
            let correctCount = 0;
            const total = questions.length;

            questions.forEach((q, index) => {
                const zone = document.querySelector(`.drop-zone[data-id="${index}"]`);
                if(!zone) return;
                const userAns = zone.innerText.trim();
                
                if (userAns === q.answer) {
                    correctCount++;
                    zone.classList.remove('wrong');
                    zone.classList.add('correct');
                } else {
                    zone.classList.remove('correct');
                    if (userAns !== '') zone.classList.add('wrong');
                }
            });

            const resultMessage = document.getElementById('result-message');
            const scoreText = document.getElementById('score-text');
            const feedbackText = document.getElementById('feedback-text');

            resultMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800');
            
            if (correctCount === total) {
                resultMessage.classList.add('bg-green-100', 'text-green-800');
                scoreText.innerText = `ğŸ† å¤ªç¥å•¦ï¼æ»¿åˆ†é€šé—œï¼`;
                feedbackText.innerText = `ä½ å·²ç¶“å®Œå…¨æŒæ¡é€™äº›èªè©äº†ï¼`;
                if(finishBtn) finishBtn.classList.remove('hidden');
                
                if ('speechSynthesis' in window) {
                    let u = new SpeechSynthesisUtterance("å¤ªæ£’äº†ï¼Œæ»¿åˆ†é€šé—œï¼");
                    u.lang = 'zh-TW'; window.speechSynthesis.speak(u);
                }
            } else {
                resultMessage.classList.add('bg-yellow-100', 'text-yellow-800');
                scoreText.innerText = `åŠ æ²¹å–”ï¼å¾—åˆ°äº† ${correctCount} / ${total} åˆ†`;
                feedbackText.innerText = `æœ‰ç´…è‰²æ¨™ç¤ºçš„éƒ¨åˆ†ç­”éŒ¯äº†ï¼Œé»æ“Šæ ¼å­å¯ä»¥æ¸…ç©ºé‡é¸å–”ï¼`;
                if(finishBtn) finishBtn.classList.add('hidden');
            }
            
            resultMessage.classList.remove('hidden');
            setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
        }

        function resetQuiz() {
            document.getElementById('result-message').classList.add('hidden');
            if(finishBtn) finishBtn.classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(initQuiz, 300);
        }

        window.onload = initQuiz;
    </script>
</body>
</html>
