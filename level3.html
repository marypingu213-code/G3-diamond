<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬ä¸‰é—œï¼šæ–‡æ„å°åµæ¢ (é¸è©å¡«ç©º)</title>
    <script src="data.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #eef2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; user-select: none; }
        
        .canvas-16-9 { width: 100%; max-width: 1400px; min-height: 85vh; background-color: #fdf5e6; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); display: flex; flex-direction: column; align-items: center; padding: 3%; box-sizing: border-box; position: relative; border: 4px solid #f39c12; }
        
        /* é ‚éƒ¨æŒ‰éˆ•èˆ‡æ¨™é¡Œ */
        .header-area { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2%; }
        h1 { color: #d35400; font-size: 28px; margin: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .header-btns { display: flex; gap: 10px; z-index: 50; }
        .back-btn { background-color: #fff; color: #5a4a42; text-decoration: none; font-size: 18px; font-weight: bold; padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s; border: 2px solid #ddd; }
        .home-btn { background-color: #1565c0; color: white; border-color: #0d47a1; }
        
        /* é¸é …æ±  (é ‚éƒ¨) */
        .pool-zone { width: 100%; background-color: #fff; border: 4px dashed #3498db; border-radius: 20px; padding: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-bottom: 30px; min-height: 100px; box-shadow: inset 0 4px 8px rgba(0,0,0,0.05); }
        
        /* æ‹–æ›³çš„èªè©æ–¹å¡Š */
        .word-card { background-color: #3498db; color: white; font-size: 28px; font-weight: bold; padding: 15px 30px; border-radius: 15px; cursor: grab; box-shadow: 0 6px 0 #2980b9; touch-action: none; transition: transform 0.1s; z-index: 10; position: relative; }
        .word-card:active { cursor: grabbing; transform: scale(1.1); box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 1000; }
        .word-card.used { visibility: hidden; pointer-events: none; } /* ç­”å°å¾Œéš±è— */

        /* å¥å­é¡¯ç¤ºå€ (ä¸‹æ–¹) */
        .sentence-area { width: 100%; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #fff9e6; border-radius: 20px; padding: 40px; box-sizing: border-box; box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
        
        .sentence-wrapper { display: flex; align-items: center; flex-wrap: wrap; justify-content: center; gap: 10px; font-size: 36px; color: #2c3e50; font-weight: bold; line-height: 1.6; }
        
        .drop-box { min-width: 120px; height: 60px; border: 4px dashed #e74c3c; background-color: #fff; border-radius: 15px; display: inline-flex; justify-content: center; align-items: center; vertical-align: middle; margin: 0 10px; transition: 0.3s; }
        .drop-box.correct { border: 4px solid #2ecc71; background-color: #eafaf1; color: #27ae60; font-size: 32px; font-weight: bold; box-shadow: 0 0 15px rgba(46, 204, 113, 0.5); }

        .speak-btn { background-color: #f1c40f; border: none; border-radius: 50px; font-size: 24px; padding: 10px 20px; cursor: pointer; box-shadow: 0 6px 0 #f39c12; font-weight: bold; color: #5a4a42; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .speak-btn:active { transform: translateY(6px); box-shadow: none; }
        
        /* ç‹€æ…‹è¨Šæ¯ */
        .status-area { min-height: 60px; margin-top: 20px; font-size: 28px; font-weight: bold; color: #e74c3c; text-align: center; }
        
        /* æ–æ™ƒå‹•ç•« (ç­”éŒ¯ç”¨) */
        .shake { animation: shake 0.4s; border-color: #e74c3c !important; background-color: #ffeaea !important; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 50% { transform: translateX(10px); } 75% { transform: translateX(-10px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>
    <div class="canvas-16-9">
        <div class="header-area">
            <h1>ğŸ” ç¬¬ä¸‰é—œï¼šæ–‡æ„å°åµæ¢</h1>
            <div class="header-btns">
                <a href="index.html" class="back-btn home-btn" onclick="stopSpeech()">ğŸ  å›ç¸½å¤§å»³</a>
                <a href="#" id="back-btn" class="back-btn" onclick="stopSpeech()">ğŸ”™ å›èª²ç¨‹é¸å–®</a>
            </div>
        </div>

        <div class="pool-zone" id="word-pool"></div>

        <div class="sentence-area">
            <button class="speak-btn" onclick="readQuestion()">ğŸ”Š è½é¡Œç›®</button>
            <div class="sentence-wrapper" id="sentence-container">
                </div>
            <div class="status-area" id="message"></div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const lessonId = urlParams.get('id') || "1"; 
        document.getElementById('back-btn').href = `lesson.html?id=${lessonId}`;
        const questionsData = allLessonsData[lessonId] ? allLessonsData[lessonId].level3 : [];

        let currentIdx = 0;
        let activeCard = null, offsetX = 0, offsetY = 0;
        let startLeft = 0, startTop = 0;

        function shuffle(array) {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW'; utterance.rate = 0.85; 
                window.speechSynthesis.speak(utterance);
            }
        }
        function stopSpeech() { if ('speechSynthesis' in window) window.speechSynthesis.cancel(); }
        
        function readQuestion() {
            let q = questionsData[currentIdx];
            // æŠŠ ________ æ›¿æ›æˆ "ä»€éº¼"ï¼Œè®“èªéŸ³å¿µèµ·ä¾†æ¯”è¼ƒè‡ªç„¶
            let speakStr = q.text.replace(/_+/g, " ä»€éº¼ ");
            speakText(speakStr);
        }

        function initGame() {
            if (questionsData.length === 0) {
                document.getElementById('sentence-container').innerHTML = "æœ¬èª²æ²’æœ‰ç¬¬ä¸‰é—œé¡Œç›®å–”ï¼";
                return;
            }
            
            // 1. æŠ“å‡ºæ‰€æœ‰ç­”æ¡ˆï¼Œæ‰“äº‚å¾Œæ”¾å…¥ä¸Šæ–¹çš„é¸é …æ± 
            const allAnswers = questionsData.map(q => q.answer);
            const shuffledAnswers = shuffle(allAnswers);
            const pool = document.getElementById('word-pool');
            pool.innerHTML = "";
            
            shuffledAnswers.forEach(word => {
                let card = document.createElement('div');
                card.className = 'word-card';
                card.innerText = word;
                card.addEventListener('pointerdown', handlePointerDown);
                pool.appendChild(card);
            });

            // 2. è¼‰å…¥ç¬¬ä¸€é¡Œ
            currentIdx = 0;
            loadQuestion();
        }

        function loadQuestion() {
            if (currentIdx >= questionsData.length) {
                document.querySelector('.speak-btn').style.display = "none";
                document.getElementById('word-pool').style.display = "none";
                document.getElementById('sentence-container').innerHTML = "ğŸ‰ æ­å–œï¼æ‰€æœ‰çš„å¡«ç©ºéƒ½å®Œæˆäº†ï¼";
                document.getElementById('message').innerText = "";
                speakText("æ­å–œï¼æ‰€æœ‰çš„å¡«ç©ºéƒ½å®Œæˆäº†ï¼");
                return;
            }

            let q = questionsData[currentIdx];
            let container = document.getElementById('sentence-container');
            container.innerHTML = "";
            document.getElementById('message').innerText = "";

            // åˆ‡å‰²å¥å­ä¸¦æ”¾å…¥ drop-box
            let parts = q.text.split(/_+/);
            
            let span1 = document.createElement('span');
            span1.innerText = parts[0];
            container.appendChild(span1);

            let dropBox = document.createElement('div');
            dropBox.className = 'drop-box';
            dropBox.id = 'drop-box';
            container.appendChild(dropBox);

            let span2 = document.createElement('span');
            span2.innerText = parts[1] || "";
            container.appendChild(span2);
        }

        // --- è§¸æ§æ‹–æ›³æ ¸å¿ƒ ---
        function handlePointerDown(e) {
            e.preventDefault();
            activeCard = this;
            activeCard.setPointerCapture(e.pointerId);

            let rect = activeCard.getBoundingClientRect();
            startLeft = rect.left;
            startTop = rect.top;
            
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            // å°‡å¡ç‰‡æå‡å±¤ç´šä¸¦æ”¹ç‚º fixed æ–¹ä¾¿å…¨è¢å¹•æ‹–æ›³
            activeCard.style.position = 'fixed';
            activeCard.style.left = startLeft + 'px';
            activeCard.style.top = startTop + 'px';
            activeCard.style.margin = '0'; 
            document.body.appendChild(activeCard);

            activeCard.addEventListener('pointermove', handlePointerMove);
            activeCard.addEventListener('pointerup', handlePointerUp);
        }

        function handlePointerMove(e) {
            if (!activeCard) return;
            e.preventDefault();
            activeCard.style.left = (e.clientX - offsetX) + 'px';
            activeCard.style.top = (e.clientY - offsetY) + 'px';
        }

        function handlePointerUp(e) {
            if (!activeCard) return;
            activeCard.releasePointerCapture(e.pointerId);
            activeCard.removeEventListener('pointermove', handlePointerMove);
            activeCard.removeEventListener('pointerup', handlePointerUp);

            let dropBox = document.getElementById('drop-box');
            let dropRect = dropBox.getBoundingClientRect();

            // åˆ¤æ–·æ˜¯å¦é‡ç–Š (ç°¡å–®ç¢°æ’åµæ¸¬)
            let isOverlapping = !(
                e.clientX < dropRect.left || 
                e.clientX > dropRect.right || 
                e.clientY < dropRect.top || 
                e.clientY > dropRect.bottom
            );

            let currentAnswer = questionsData[currentIdx].answer;

            if (isOverlapping) {
                if (activeCard.innerText === currentAnswer) {
                    // ğŸŒŸ ç­”å°äº†ï¼
                    dropBox.innerText = currentAnswer;
                    dropBox.classList.add('correct');
                    activeCard.classList.add('used'); // éš±è—å¡ç‰‡
                    
                    document.getElementById('message').style.color = "#2ecc71";
                    document.getElementById('message').innerText = "ğŸŒŸ ç­”å°äº†ï¼å¤ªæ£’äº†ï¼";
                    
                    // æœ—è®€å®Œæ•´æ­£ç¢ºå¥å­
                    speakText(questionsData[currentIdx].text.replace(/_+/g, currentAnswer));
                    
                    // ç­‰å¾… 2.5 ç§’å¾Œæ›ä¸‹ä¸€é¡Œ (è®“å­¸ç”Ÿæœ‰æ™‚é–“è½å®Œå¥å­)
                    setTimeout(() => {
                        currentIdx++;
                        loadQuestion();
                    }, 2500);

                } else {
                    // âŒ ç­”éŒ¯äº†
                    document.getElementById('message').style.color = "#e74c3c";
                    document.getElementById('message').innerText = "å“å‘€ï¼Œå¥½åƒä¸æ˜¯é€™å€‹è©å–”ï¼";
                    dropBox.classList.add('shake');
                    speakText("å“å‘€ï¼Œå¥½åƒä¸æ˜¯é€™å€‹è©å–”ï¼");
                    
                    setTimeout(() => dropBox.classList.remove('shake'), 400);
                    returnToPool(activeCard);
                }
            } else {
                // æ²’ä¸Ÿé€²æ¡†æ¡†ï¼Œå½ˆå›åŸä½
                returnToPool(activeCard);
            }
            activeCard = null;
        }

        function returnToPool(card) {
            let pool = document.getElementById('word-pool');
            pool.appendChild(card);
            card.style.position = 'relative';
            card.style.left = 'auto';
            card.style.top = 'auto';
            card.style.margin = '0';
        }

        window.onload = initGame;
    </script>
</body>
</html>
